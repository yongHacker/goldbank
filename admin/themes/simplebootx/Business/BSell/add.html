<businesstpl file="header" />
<style type="text/css">
    .table .search_input{
        margin: 0;
        padding: 0;
        position: relative;
    }
    #mobile-name{
        margin:8px 5px;
        text-indent: 20px;
    }
    .myModal3.leave{
        position: absolute;
        top:12px;
        left:15px;
        font-size: 14px;
    }
    .ta select,.ta input{
        width: 110px;
    }
    input[type="number"] { text-align: right;}
    .no_arrow::-webkit-outer-spin-button, .no_arrow::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0;}
    .no_arrow { -moz-appearance: textfield;}
</style>
</head>
<body class=" theme-blue">
<div class="wrap js-check-wrap">
    <ul class="nav nav-tabs">
        <!--<li><a href="{:U('sells/index')}">销售列表</a></li>-->
        <li class="active"><a href="{:U('BSell/add')}">{:L('BUSINESS_BSELL_ADD')}</a></li>
    </ul>
    <table class="table table-bordered" id="order_base">
        <tr>
            <!--<td class="sel" width="20%">日期</td>
            <td width="30%">
                {$today}
            </td>-->
            <td class="sel">门店</td>
            <td width="30%">
                <select id="shop" name="shop_id" data-live-search="true">
                    <if condition="$shop_id elt 0">
                        <option value="0" checked currency_id="{$currency[0]['id']}" default_rate="{$currency[0]['exchange_rate']}" unit="{$currency[0]['unit']}">总部</option>
                    </if>
                    <volist name="shop" id="v">
                        <option value="{$v.id}" show_common_payment="{$v.show_common_payment}" in_user="{$v.user_nicename}" currency_id="{$v.currency_id}" unit="{$v.unit}" default_rate="{$v.exchange_rate}"  checked>{$v.shop_name}</option>
                    </volist >
                </select>
            </td>
            <td class="sel">销售员</td>
            <td width="30%">{$user_nicename}</td>
        </tr>
        <tr>
            <td class="sel">销售方式</td>
            <td width="30%" >
                <span><label style="display: inline"><input type="radio" style="width: auto" value="1" name="sell_type" checked="checked">&nbsp;&nbsp;零售&nbsp;&nbsp;</label></span>
                <span><label style="display: inline"><input type="radio" style="width: auto" value="2" name="sell_type" >&nbsp;&nbsp;以旧换新</label></span>
            </td>
            <td class="sel">外部订单号</td>
            <td ><input type="text" autocomplete="off" id ='sn_id' name="sn_id"></td>
        </tr>
        <tr>

            <td class="sel">会员</td>
            <td class="search_input" width="30%">
                <input type="text" autocomplete="off" id="mobile-name" class="form-control" onclick="$('#myModal3').modal('show');"> <!--style="display: none;"-->
                <input type="hidden" autocomplete="off" id="mobile" class="form-control">
                <input type="hidden" id="uid" class="form-control" value="">
                <input type="hidden" id="employee_id" class="form-control" value="">
                <a href="#myModal3" class="myModal3 leave" data-toggle="modal" name="{$v.id}" role="button"><span><i class="fa fa-search normal"></i></span></a>
            </td>
            <td class="sel">开单日期</td>
            <td width="30%">
                <input id="sell_date" class="form-control datepicker js-date span2" name="sell_date" value="{$today}" type="text">
            </td>
        </tr>
        <tr>
            <td class="sel">销售数量</td>
            <td width="30%" id="total_num"></td>
            <td class="sel gold">销售总额</td>
            <td width="30%"><span id="count">0</span></td>

        </tr>
        <tr class="hide client_idno">

            <td class="sel">身份证号</td>
            <td colspan="3"><input type="text" autocomplete="off" id ='client_idno' name="client_idno"></td>
        </tr>
        <tr>
            <td class="sel">抹零金额</td>
            <td  width="30%">
                <div class="input-append" style="margin-bottom:0;">
                    <input type="number" step="0.01" class="span2" id="extra_price">
                    <span class="add-on">元</span>
                </div>
            </td>
            <td class="sel">备注</td>
            <td width="30%"><textarea type="text" id="remark"></textarea></td>
        </tr>
    </table>
    <div class="main-content" >
        <div class="ta" id="order_product" style="overflow-x: auto;">
            <table class="table table-bordered  table-hover" >
                <thead >
                <tr>
                    <th>序</th>
                    <th style="width: 160px;">货品编号</th>
                    <th>名称</th>
                    <th>规格</th>
                    <th>含金量(‰)</th>
                    <th hidden="hidden">零售价/金价</th>
                    <th>销售工费方式</th>
                    <th style="width: 80px;">件/克工费</th>
                    <th style="width: 80px;">克单价</th>
                    <th>重量(克)</th>
                    <th>实称克重(克)</th>
                    <th style="width: 80px;">建议售价</th>
                    <th style="width: 80px;">单品优惠</th>
                    <th style="width: 80px;">销售价</th>
                    <th>计价方式</th>
                    <th hidden="hidden">id</th>
                    <th>是否截金</th>
                    <th>截后克重</th>
                    <th class="text-center" style="width: 40px;">操作</th>
                </tr>
                </thead>
                <tbody id="tbody" class="sell_tbody">
                <tr id="last">
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="price"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center myModal2 on" href="#myModal2" style="cursor:pointer;" data-toggle="modal" role="button"><a href="javascript:void(0);">+</a></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="recovery_wh_id hide" style="margin-bottom: 20px">
            <span class="sel">金料仓库</span>
            <span colspan="3">
                <select id="mystore" name="wh_id" data-live-search="true" style="margin-bottom: 0px">
                    <option value="0" checked>选择仓库</option>
                </select>
            </span>
        </div>
        <div class="ta hide" id="recovery_old_product" style="overflow-x: auto;">
            <ul class="nav nav-tabs">
                <li class="active"><a href="javascript:void(0);">以旧换新</a></li>
            </ul>
            <table class="table table-bordered  table-hover table-responsive">
                <thead>
                <tr>
                    <th>序</th>
                    <th style="width: 160px;">金料名称</th>
                    <th style="width: 160px;">金料编号</th>
                    <th style="width: 160px;">总重</th>
                    <th>纯度(‰)</th>
                    <th>金重</th>
                    <th>回购金价</th>
                    <th>当前金价</th>
                    <th>服务克工费</th>
                   <!-- <th>损耗率</th>-->
                    <th style="width: 80px;">抵扣费用</th>
                    <th >材质</th>
                    <th >颜色</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody id="old_product_tbody">
                <tr id="old_product_last">
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <!--<td class="text-center"></td>-->
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center" id="add_old_product" style="cursor: pointer;">
                        <a href="javascript:void(0);">+</a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        <div id="recovery_table" class="ta hide">
            <ul class="nav nav-tabs">
                <li class="active"><a href="javascript:void(0);">截金列表</a></li>
            </ul>
            <table class="table table-bordered  table-hover">
                <thead >
                <tr>
                    <th>序</th>
                    <th style="width:220px;">关联货号</th>
                    <th >金料名称</th>
                    <th >金料编号</th>
                    <th >截金总重</th>
                    <!--<th style="width:220px;">截金金重</th>-->
                    <th >截金金价</th>
                    <th >服务克工费</th>
                    <th style="width:220px;">纯度(‰)</th>
                    <!-- <th style="width:220px;">损耗率</th>-->
                    <th >抵扣费用</th>
                    <th >材质</th>
                    <th >颜色</th>
                </tr>
                </thead>
                <tbody id="tbody" class="recovery_tbody">
                <!--<tr id="last" class="recovery_type_tr">
                </tr>-->
                </tbody>
            </table>
        </div>

        <div class="ta" id="sell_sub">
            <ul class="nav nav-tabs">
                <li class="active"><a href="javascript:void(0);">其它费用</a></li>
            </ul>
            <table class="table table-bordered table-hover" >
                <thead>
                <tr>
                    <th class="text-center">序</th>
                    <th class="text-center">费用类目</th>
                    <th class="text-center">费用金额</th>
                    <th class="text-center" style="width: 40px;">操作</th>
                </tr>
                </thead>
                <tbody id="sub_tbody">
                <tr id="sub_last">
                    <td class="text-center"></td>
                    <td class="text-center expence_id">
                        <select name="expence_id" style="width:220px;">
                            <option value="0">选择类目</option>
                            <volist name="expence_list" id="v">
                                <option value="{$v.id}" checked>{$v.name}</option>
                            </volist >
                        </select>
                    </td>
                    <td class="text-center sub_price">
                        <input type="number" autocomplete="off" class="sub_cost" step="0.01" value="" placeholder="类目金额" style="width:220px;">
                    </td>
                    <td class="text-center" id="sub_add" role="button" style="cursor:pointer;"><a href="javascript:void(0);">+</a></td>
                </tr>
                </tbody>
            </table>
            <!--其它费用类目html-->
            <div id="expence_html" hidden="hidden">
                <select name="expence_id" style="width:220px;">
                    <option value="0" checked>选择类目</option>
                    <volist name="expence_list" id="v">
                        <option value="{$v.id}">{$v.name}</option>
                    </volist >
                </select>
            </div>
        </div>
        <ul class="nav nav-tabs">
            <li class="active"><a href="javascript:void(0);">收款明细</a></li>
        </ul>
        默认币种：<span class="count_unit">{$currency[0]['currency_name']}</span>&nbsp;&nbsp;&nbsp;默认汇率：<span class="default_rate">{$currency[0]['exchange_rate']}</span>%
        <div class="ta">
            <table class="table table-bordered  table-hover">
                <thead >
                <tr>
                    <th>序</th>
                    <th style="width:220px;">收款方式</th>
                    <th >币种</th>
                    <th style="width:220px;">流水号</th>
                    <th style="width:100px;">收款金额</th>
                    <th style="width:220px;">计算单位</th>
                    <th style="width:220px;">汇率％</th>
                    <th>收款类型</th>
                    <th style="width:220px;">计算金额</th>
                    <th style="width:160px;">操作</th>
                </tr>
                </thead>
                <tbody id="tbody" class="pay_tbody">
                <tr id="last" class="pay_type_tr">
                    <td class="text-center"></td>
                    <td class="text-center pay_id">
                        <select name="pay_id">
                            <option value="0" pay_type="{$vo.pay_type}">选择收款方式</option>
                            <volist name="payment" id="vo">
                                <option value="{$vo.id}" pay_type="{$vo.pay_type}">{$vo.pay_name}</option>
                            </volist>
                        </select>
                    </td>
                    <td class="text-center currency" >
                        <select name="currency" style="width:90px;" >
                            <option value="0" >选择币种</option>
                            <volist name="currency" id="vo">
                                <option value="{$vo.id}" exchange_rate="{$vo.exchange_rate}" unit="{$vo.unit}">{$vo.currency_name}</option>
                            </volist>
                        </select>
                    </td>
                    <td class="text-right flow_id">
                        <!-- <input type="text" autocomplete="off" name="flow_id" value="" placeholder="流水号"> -->
                        -<input type="hidden" name="flow_id" >
                    </td>
                    <td class="text-right pay_price"><input type="number" step="0.01" autocomplete="off" name="pay_price" value="0"></td>
                    <td class="text-center unit"></td>
                    <td class="text-center exchange_rate"></td>
                    <td class="text-center pay_type"></td>
                    <td class="text-right actual_price">0.00</td>
                    <td class="text-center" id="add_pay_type" style="color: #3daae9;cursor:pointer;">+添加收款方式</td>
                </tr>
                <tr id="count_pay">
                    <td class="text-center"></td>
                    <td class="text-center" colspan="3">计算金额=收款金额*汇率/默认汇率</td>
                    <td class="text-center" colspan="2">总计：<span id="count_sell_price">0.00</span><span class="count_unit">{$currency[0]['unit']}</span></td>
                    <td class="text-center" colspan="2">已经支付：<span id="count_price">0.00</span><span class="count_unit">{$currency[0]['unit']}</span></td>
                    <td class="text-center" colspan="2">还需支付：<span id="need_price">0.00</span><span  class="count_unit">{$currency[0]['unit']}</span></td>
                    <!-- <td class="text-center" colspan="5">还需支付：<span id="need_price">0.00</span>{$currency[0]['unit']}</td>-->
                </tr>
                </tbody>
            </table>
            <!--收款方式html-->
            <div id="pay_html" hidden="hidden">
                <select name="pay_id"  >
                    <option value="0" pay_type="0">选择收款方式</option>
                    <volist name="payment" id="vo">
                        <option value="{$vo.id}" pay_type="{$vo.pay_type}">{$vo.pay_name}</option>
                    </volist>
                </select>
            </div>
            <!--币种方式html-->
            <div id="currency_html" hidden="hidden">
                <select name="currency"  >
                    <option value="0" >选择币种</option>
                    <volist name="currency" id="vo">
                        <option value="{$vo.id}" exchange_rate="{$vo.exchange_rate}" unit="{$vo.unit}">{$vo.currency_name}</option>
                    </volist>
                </select>
            </div>
        </div>
        <div class="form-actions">
            <div class="center-block" style="width:260px; margin: 0 auto;">
                <button type="button" class="btn btn-primary baocun" id="baocun" data-type="-1">{:L('SAVE')}</button>
                <button type="button" class="btn btn-primary submit" id="submit" data-type="0">提交</button>
                <div class="tishi" style="color: red;"></div>
                <div>
                </div>
                <div class="modal small fade" style="width:80%;left:400px;top:2%;bottom: 2%;display:none" id="myModal2" hidden=hidden tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                <b id="myModalLabel" style="margin: 0;font-family: 'Microsoft Yahei', verdana;color: #157ab5;">货品列表</b>
                            </div>
                            <div class="modal-body" style="max-height: 500px;padding: 0px;margin:0px">
                                <iframe frameborder="0" class="appiframe" src="{:U('BSell/product_list')}" id="goods_index" name="goods_index">

                                </iframe>
                            </div>
                            <div class="modal-footer">
                                <button id="check" class="btn btn-primary pull-left" >选中</button>
                                <button id="cancel" class="btn btn-default" data-dismiss="modal" aria-hidden="true">返回</button>
                                <button id="add" class="btn btn-primary" data-dismiss="modal">选中并关闭</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal small fade" style="width:80%;left: 400px;top:2%;bottom: 2%;display:none" id="myModal3" hidden=hidden tabindex="-1" role="dialog" aria-labelledby="clientModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                <b id="clientModalLabel" style="margin: 0;font-family: 'Microsoft Yahei', verdana;color: #157ab5;">选择会员</b>
                            </div>
                            <div class="modal-body" style="max-height: 500px;padding: 0px;">
                                <iframe  frameborder="0" class="appiframe" src="{:U('BSell/client_list')}" id="goods_index2" name="goods_index2" onload="loadFrame(this)">

                                </iframe>
                            </div>
                            <div class="modal-footer">
                                <button id="cancel" class="btn btn-default" data-dismiss="modal" aria-hidden="true">返回</button>
                                <button id="add-2" class="btn btn-primary" data-dismiss="modal">选中</button>
                            </div>
                        </div>
                    </div>
                </div>
<script src="__PUBLIC__/lib/datepicker/js/laydate.dev.js"></script>
<script src="__PUBLIC__/lib/bootstrap/js/tree.js"></script>
<script src="__PUBLIC__/js/common.js"></script>
<script src="__PUBLIC__/js/jquery-ui.min.js"></script>
<!--收款方式-->
<script>
    var rproduct_code_num="{:get_rproduct_code_num()}";
    var day="{:date('ymd')}";
    function update_rproduct_code(rproduct_code_tr,rproduct_type){
        var tbody=rproduct_type==1?$('#old_product_tbody'):$('.recovery_tbody');
        if(rproduct_code_tr){
            var rproducts_codes=[];
            rproduct_code_tr=rproduct_code_tr.split(',');
            $.each(rproduct_code_tr,function(i,item){
                console.log(i+"--"+item);
                if(item){
                    rproduct_code_num=parseInt(rproduct_code_num)+1;
                    var str='000'+rproduct_code_num;
                    var rproduct_code=day+str.substr(str.length-4);
                    tbody.find('input[name=rproduct_code]').eq(item-1).val(rproduct_code);
                    rproducts_codes.push(rproduct_code);
                }
            });
            return rproducts_codes.join(',');
        }
    }
    $(document).ready(function(){
        $('#mobile').val('');
        $('#uid').val('');
    })

    //获取收款列表数据
    function getall_pay_type(){
        var is_true=true;
        var datas = [];
        var tr= $(".ta").find('table tbody tr[class="pay_type_tr"]');
        var i=1;
        tr.each(function(){
            var pay_id =$(this).find(".pay_id").find('select').val();
            var currency=$(this).find(".currency").find('select').val();
            var currency_rate=$(this).find(".exchange_rate").text();
            var flow_id =$(this).find(".flow_id").find('input').val();
            var pay_price =$(this).find(".pay_price").find('input').val();
            var actual_price =$(this).find(".actual_price").text();
            if(!pay_id||pay_id==0){
                $('.tishi').html('第'+i+'行未选择收款方式');
                artdialog_alert('第'+i+'行未选择收款方式');
                is_true=false;
                return false;
            }
            if(!currency||currency==0){
                $('.tishi').html('第'+i+'行收款方式未选择币种');
                artdialog_alert('第'+i+'行收款方式未选择币种');
                is_true=false;
                return false;
            }
            if(!pay_price||pay_price==0){
                $('.tishi').html('第'+i+'行收款方式未填写金额');
                artdialog_alert('第'+i+'行收款方式未填写金额');
                is_true=false;
                return false;
            }
            i=i+1;
            if(actual_price&&currency&&pay_id){
                datas.push({
                    'pay_id': pay_id,
                    'flow_id': flow_id,
                    'currency': currency,
                    'currency_rate': currency_rate,
                    'pay_price': pay_price,
                    'actual_price': actual_price
                });
            }
        });
        if(is_true){
            return JSON.stringify(datas);
        }else {
            return false;
        }
    }
    //删除收款记录
    function del_pay_type() {
        $(".pay_del").unbind("click").click(function() {
            $(this).parent("tr").remove();
            change_countprice();
            change_needprice();
        });
    }
    //总金额修改或收款金额修改
    function change_pay_price() {
        $("#count").unbind('change').change(function() {
            change_needprice();
        })
        $("input[name='pay_price']").unbind('keyup').keyup(function() {
            change_countprice();
            change_needprice();
        });
        /*change by alam 2018/5/8 start*/
        $("#extra_price").unbind('keyup').keyup(function() {
            count_price2();
            change_needprice();
        });
        /*change by alam 2018/5/8 end*/
    }
    //修改还需支付的金额
    function change_needprice() {
        var count_price = $("#count_price").text();
        var count = $("#count").html();
        var need_price = count - count_price;
        $("#need_price").text(need_price.toFixed(2));
    }
    //修改已经支付的金额和计算金额
    function change_countprice() {
        //默认币种汇率
        var shop_id=$("select[name='shop_id']").val();
       // if(shop_id==0){
            var default_exchange_rate="{$currency[0]['exchange_rate']}";
            if(!default_exchange_rate){
                default_exchange_rate=100;
            }
        /*}else {
            var default_exchange_rate=$("select[name='shop_id']").find("option:selected").attr("default_rate");
            if(!default_exchange_rate){
                default_exchange_rate=100;
            }
        }*/
        var con = 0;
        $("input[name='pay_price']").each(function(key,val) {
            var pay_price=$(this).val();
            var actual_price=0;
            if(pay_price==''){
                pay_price=0;
            }else {
                var exchange_rate =$(this).parent().parent().find(".exchange_rate").text();
                var actual_price=pay_price*(exchange_rate)/default_exchange_rate;
            }
            actual_price=actual_price.toFixed(2);
            $(this).parent().parent().find(".actual_price").text(actual_price);
            con = parseFloat(con) + parseFloat(actual_price);
        })
        $("#count_price").text(con.toFixed(2));
    }
    //修改收款方式
    function change_pay_type(){
        $(".pay_id").find("select[name='pay_id']").unbind('change').change(function () {
            var pay_type=$(this).find("option:selected").attr("pay_type");
            if(pay_type>0){
                $(this).parent().parent().find(".pay_type").text("系统内支付");
                $(this).closest('tr').find('.flow_id').html('<input type="text" autocomplete="off" name="flow_id" value="" placeholder="流水号">');
            }else {
                $(this).parent().parent().find(".pay_type").text("系统外支付");
                $(this).closest('tr').find('.flow_id').html('-<input type="hidden" name="flow_id" >');
            }
        })
    }
    //币种选取，修改币种参数以及计算金额和已经支付金额，还需支付金额
    function change_exchange_rate(){
        $(".currency").find("select[name='currency']").unbind('change').change(function () {
            var exchange_rate=$(this).find("option:selected").attr("exchange_rate");
            var unit=$(this).find("option:selected").attr("unit");
            $(this).parent().parent().find(".exchange_rate").text(exchange_rate);
            $(this).parent().parent().find(".unit").text(unit);
            //默认币种汇率
            var shop_id=$("select[name='shop_id']").val();
            //if(shop_id==0){
                var default_exchange_rate="{$currency[0]['exchange_rate']}";
                if(!default_exchange_rate){
                    default_exchange_rate=100;
                }
           /* }else {
                var default_exchange_rate=$("select[name='shop_id']").find("option:selected").attr("default_rate");
                if(!default_exchange_rate){
                    default_exchange_rate=100;
                }
            }*/
            var pay_price=$(this).parent().parent().find("input[name='pay_price']").val();
            var actual_price=pay_price*exchange_rate/default_exchange_rate;
            console.log(default_exchange_rate);
            console.log(exchange_rate);
            console.log(actual_price);
            actual_price=actual_price.toFixed(2);
            $(this).parent().parent().find(".actual_price").text(actual_price);
            change_countprice();
            change_needprice();
        })
    }
    //添加一列收款记录
    function add_pay_type(){
        $("#add_pay_type").unbind('click').click(function () {
            var pay_id_html=$("#pay_html").html();
            var currency_html=$("#currency_html").html();
            var html='<tr class="pay_type_tr">';
            html+='<td class="text-center"></td>';
            html+='<td class="text-center pay_id">'+pay_id_html+'</td>';
            html+='<td class="text-center currency">'+currency_html+'</td>';
            // html+='<td class="text-right flow_id"><input type="text" autocomplete="off" name="flow_id" value="" placeholder="流水号"></td>';
            html+='<td class="text-right flow_id">-<input type="hidden" name="flow_id" ></td>';
            html+='<td class="text-right pay_price"><input type="text" autocomplete="off" name="pay_price" value="0" placeholder="收款金额"></td>';
            html+='<td class="text-center unit"></td>';
            html+='<td class="text-right exchange_rate"></td>';
            html+='<td class="text-center pay_type"></td>';
            html+='<td class="text-right actual_price">0.00</td>';
            html+='<td class="text-center pay_del" style="color: #3daae9;cursor:pointer;">删除</td>';
            html+='</tr>';
            $(".pay_tbody").find("#last").before(html);
            table_order();
            change_pay_type();
            change_exchange_rate();
            change_pay_price();
            del_pay_type();
        })
    }
    change_pay_type();
    add_pay_type();
    change_exchange_rate();
    change_pay_price();
    //清楚收款方式信息
    function clear_pay_info(){
        if($('.pay_type_tr').length>2){
            var html='<tr id="last" class="pay_type_tr">';
            html+=$(".pay_tbody").find("#last").html();
            html+='</tr>';
            $(".pay_type_tr").remove();
            $("#count_pay").before(html);
            change_countprice();//更新已收款金额
        }
    }
</script>
<!--收款方式  end-->
<script type="text/javascript">

    // heightAuto($("#myModal2"));
    // heightAuto($("#myModal3"));

    localStorage.removeItem('p_id');
    $("#myModal3").on("shown.bs.modal",function () {
        $("#goods_index2").contents().find("#mobile").focus();
    })
    //销售总价
    function count_price2(){
        var con = 0;
        $('tr td .price2').each(function(key,val){
            if($(this).val()){
                con = parseFloat(con) + parseFloat($(this).val());
            }
        })
        var cut_cost_price = count_price();
        var old_cost_price = count_old_product_price();
        con = con - parseFloat(cut_cost_price)- parseFloat(old_cost_price);
        /*change by alam 2018/5/8 start*/
        // 其它费用
        $('tr td .sub_cost').each(function(key,val){
            if($(this).val()){
                con = parseFloat(con) + parseFloat($(this).val());
            }
        })
        // 抹零金额
        var extra_price = $('#extra_price').val();
        con = con - extra_price;
        /*change by alam 2018/5/8 end*/
        $('#count').html(con.toFixed(2));
        $('#count_sell_price').html(con.toFixed(2));
        $('#total_price').val(con.toFixed(2));
        change_needprice();
    }
    //销售价、其它费用改变 销售总价改变
    function count(){
        $("input[class='price2']").unbind('keyup').keyup(function(){
            count_price2();
        })
        /*change by alam 2018/5/8 start*/
        $("input[class='sub_cost']").unbind('keyup').keyup(function(){
            count_price2();
        })
        /*change by alam 2018/5/8 end*/
    }
    //优惠价,克工费,克单价，实称克重改变销售价和销售总价
    function td_change(){
        // $("input[name='discount_price'],input[name='m_fee'],input[name='sell_g_price'],input[name='goods_weight']").unbind('keyup').keyup(function(){
        $("input[name='discount_price'],input[name='sell_g_price'],input[name='goods_weight']").unbind('keyup').keyup(function(){

            var tr = $(this).closest('tr');

            var gold_price = parseFloat(tr.find('.gold_price').find('input').val());//金价
            gold_price = isNaN(gold_price)? 0 : gold_price;

            var discount_price = parseFloat(tr.find('.discount_price').find('input').val());//单品优惠
            discount_price = isNaN(discount_price) ? 0 : discount_price;

            // var m_fee = parseFloat(tr.find('.goods_gram_price').find('input').val())>0?parseFloat(tr.find('.goods_gram_price').find('input').val()):0;//工费
            var m_fee = parseFloat(tr.find('.goods_gram_price').text())>0?parseFloat(tr.find('.goods_gram_price').text()):0;//工费
            m_fee = m_fee == '' ? 0 : m_fee;

            var goods_weight = parseFloat(tr.find('.goods_weight').find('input').val());//重量
            goods_weight = isNaN(goods_weight) ? 0 : goods_weight;

            //计价
            var sell_price = tr.find('.goods_unit_price').find('input').attr("price");//销售价
            var jijia = tr.find('.jijia').text();
            var price2 = 0;

            //销售工费方式
            var sell_feemode=tr.attr('sell_feemode');

            if(jijia =='计件'){
                price2 = sell_price - $(this).val();
            }else{
                if(sell_feemode==1){
                    price2 = ((parseFloat(gold_price)+parseFloat(m_fee)) * (parseFloat(goods_weight))-parseFloat(discount_price));
                }else if(sell_feemode==0){
                    price2 = ((parseFloat(gold_price)) * (parseFloat(goods_weight))+parseFloat(m_fee)-parseFloat(discount_price));
                }

            }
            tr.find('.goods_unit_price').find('input').val(price2.toFixed(2));

            count_price2();
        })
    }
    var tr_order=1;

    function table_order(){
        var len = $(".ta").find('table tr').length;
        for(var i = 1; i < len;i ++){
            $(".ta").find('table tr:eq('+i+') td:first').text(i);
        }
        count_num();
    }

    function del(){
        $(".del").click(function(){
            tr.remove();
        });
    }

    function del_input(){
        //删除tr
        $(".del").each(function(){
            $(this).click(function(){
                var tr=$(this).parent().parent();
                tr.remove();
                table_order();
                var price = tr.find('.goods_unit_price').find('input').val();
                var count = $('#count').html();
                if(price){
                    if(count !='' && count != NaN){
                        count2 =(parseFloat(count)-parseFloat(price)).toFixed(2);
                    }
                }
                count_price2();
                $('#total_price').val(count2);
                var checked=localStorage.getItem('p_id');
                var p_id=tr.find(".goods_id").find("input").val();
                checked=checked.replace("ck"+p_id+"ck","");
                localStorage.setItem('p_id',checked);
                //删除后将图片换回复选框
                var html=$('#goods_index').contents();
                var img=html.find(".ta").find("tbody img[p_id='ck"+p_id+"ck']");
                var checkbox=html.find(".ta").find("tbody input[p_id='ck"+p_id+"ck']");
                checkbox.show();
                checkbox.prop('checked',false);
                img.remove();

                // 删除对应截金
                var product_code = tr.find('.goods_code').text();
                del_recovery_tr(product_code);
            });
        });
    }
    $("#myModal2").draggable();
    $("#myModal3").draggable();
    $("#tr_add").click(function(){
        var s=$("#last_tr").prev().find(".goods_order").text();
        var ss=parseInt(s)+1;
        var html="";
        html+="<tr>";
        html+=$("#tr_info").html();
        html+="</tr>";
        $("#last_tr").before(html);
        $("#last_tr").prev().find(".goods_order").text(ss);
        table_order();
        myModal2();
        del_input();
    });
    $('#goods_index').load(function () {
        $("#check").unbind('click').click(function(){
            var html=$('#goods_index').contents();
            var tr=html.find("input[class='goods_input']:checked").parent().parent();
            var tr2=$(this).parent().parent();
            tr.each(function(){
                if ($(this).find("td:nth-child(1)").find("img").length > 0) {

                }else{
                    var s=$("#last_tr").prev().find(".goods_order").text();
                    var ss=parseInt(s)+1;
                    var p_id=$(this).find(".goods_id_code").find("input").attr("p_id");
                    var checked=localStorage.getItem('p_id');
                    checked+=","+p_id;
                    localStorage.setItem('p_id',checked);
                    var sell_feemode=$(this).attr('sell_feemode');
                    var html="";
                    html+="<tr id='zz' class='' sell_feemode='"+sell_feemode+"' gold_price='"+$(this).attr('gold_price')+"' gold_type='"+$(this).attr('gold_type')+"' product_code='"+$(this).find(".goods_code").text()+"'>";
                    html+='<td class="goods_order text-center" >'+$(this).find(".goods_order").text()+'</td>';
                    html+=' <td class="goods_code text-center">'+$(this).find(".goods_code").text()+'</td>';
                    html+=' <td class="goods_name">'+$(this).find(".goods_name").text()+'</td>';
                    html+=' <td class="goods_spec t">'+$(this).find(".goods_spec").text()+'</td>';
                    html+=' <td class="goods_purity text-center">'+$(this).find(".goods_purity").text()+'</td>';

                    if($(this).find(".goods_way").text()=='计件'){
                        html+='<td class="sell_feemode">--</td>';
                        html+=' <td hidden="hidden" class="price">'+$(this).find(".goods_unit_price").text()+'</td>';
                        html += ' <td class="goods_gram_price text-right">'+ $(this).find(".goods_gram_price").text() +'</td>';
                        // '<input style="background-color: #eee;" readonly="readonly" type="text"  name="m_fee" class="m_fee" value=' + $(this).find(".goods_gram_price").text() + '> </td>';
                        html+=' <td class="gold_price">' +
                                '<input type="text" autocomplete="off" name="sell_g_price" readonly="readonly" class="sell_g_price" value='+($(this).attr('gold_price')>0?$(this).attr('gold_price'):0)+'></td>';
                    }else{
                        var sell_feemode_name=sell_feemode==1?'克工费销售':(sell_feemode==0?'件工费销售':'');
                        html+='<td class="sell_feemode">'+sell_feemode_name+'</td>';
                        html+=' <td hidden="hidden">'+$(this).attr('gold_price')+'</td>';
                        html += ' <td class="goods_gram_price text-right">' +  $(this).find(".goods_gram_price").text() +'</td>'
                        // '<input style="background-color: #eee;"  type="text" name="m_fee" class="m_fee" readonly="readonly" value=' + $(this).find(".goods_gram_price").text() + '> </td>';
                        html+=' <td class="gold_price">' +
                                '<input type="text" autocomplete="off" name="sell_g_price" class="sell_g_price" value='+($(this).attr('gold_price')>0?$(this).attr('gold_price'):0)+'></td>';
                    }
                    //    html+=' <td class="goods_gram_price"><input type="text" autocomplete="off" name="m_fee" class="m_fee" value='+$(this).find(".goods_gram_price").text()+'> </td>';
                    html+=' <td class="procure_weight">'+$(this).find(".goods_weight").text()+'</td>';
                    if($(this).find(".product_type").text()!='1'){
                        html+=' <td class="goods_weight">--</td>';
                    }else{
                        if($(this).find(".goods_way").text()=='计件') {
                            html += ' <td class="goods_weight"><input readonly="readonly" type="text" autocomplete="off"   class="g text-right" name="goods_weight" value=' + $(this).find(".goods_weight").text() + ' /></td>';
                        }else {
                            html+=' <td class="goods_weight"><input type="text" autocomplete="off"   class="g text-right" name="goods_weight" value='+$(this).find(".goods_weight").text()+' /></td>';
                        }

                    }
                    html+=' <td  class="be_onsale_price">'+ $.trim($(this).find(".goods_unit_price").text())+'</td>';
                    html+=' <td  class="discount_price"><input type="text" autocomplete="off" name="discount_price" class="discount_price"   value="0"></td>';
                    html+=' <td  class="goods_unit_price price2"><input type="text" autocomplete="off" name="price2" class="price2" price='+ $(this).find(".goods_unit_price").text()+'  value='+ $(this).find(".goods_unit_price").text()+'></td>';
                    html+='<td class="jijia text-center">'+$(this).find(".goods_way").text()+'</td>';
                    html+='<td class="goods_id" hidden ="hidden"><input id ="pid" type="text" value='+$(this).find(".goods_id").text()+'></td>';
                    //  html+='<td hidden ="hidden">'+$(this).find("td:nth-child(11)").text()+'</td>';
                    if($(this).find(".product_type").text()!='1'){
                        html+='<td class="is_cut">/</td>';
                        html+='<td class="cut_weight">/</td>';
                    }else{
                        html+='<td class="is_cut"><select name="is_cut"><option value="1">是</option><option selected="selected" value="0">否</option></select></td>';
                        html+='<td class="cut_weight">0.00<input type="hidden" product_code="'+$(this).find(".goods_code").text()+'" name="cut_weight" value="0.00"></td>';
                    }
                    html+='<td class="text-center">'
                    html+='<a href="javascript:void(0);" name="{$v.id}"  class="del" role="button" data-toggle="modal">删除</i></a>';
                    html+='</td>';
                    html+='</tr>';
                    $("#last").before(html);
                }
            });
            //刷新页面读取已勾选数据
            var check=localStorage.getItem('p_id');
            if(check!=""&&check!=null&&typeof(check)!="undefined"){
                var checked=check.split(',');
                for(var i in checked){
                    if(checked[i]!=null&&checked[i]!=""&&typeof(checked[i])!="undefined"){
                        var checkbox=tr.find("input[p_id='"+checked[i]+"']");
                        var imglength=checkbox.parent().find("img").length;
                        if(checkbox.length>0&&imglength==0){
                            var img= "<img p_id='"+checked[i]+"' src='__PUBLIC__/images/gou.png'/>";
                            checkbox.parent().append(img);
                            checkbox.prop('checked',false);
                            checkbox.hide();
                        }
                    }
                }
            }
            cutweight();
            table_order();
            myModal2();
            del_input();
            count_price2();
            count();
            td_change();
            del();
        })
        $("#add").unbind('click').click(function(){
            $("#check").trigger("click");
        })
    });

    $('#add-2').click(function(){
        // name = localStorage.getItem('sell_name');
        // mobile = localStorage.getItem('sell_mobile');
        // uid = localStorage.getItem('sell_uid');

        var ckbox = $("#goods_index2").contents().find('.check_box:checked');

        if(ckbox != undefined){
            var name = ckbox.attr("u_name");
            var uid = ckbox.attr("uid");
            var employee_id = ckbox.attr("employee_id");
            var mobile = ckbox.attr("mobile");

            if(empty(name)){
                name='';
            }
            $('#mobile').val(name);
            $('#mobile-name').val(name+'('+mobile+')');
            $('#uid').val(uid);
            $('#employee_id').val(employee_id);
        }
    })
    function myModal2(){
        $('.myModal2').each(function () {
            $(this).click(function(){
                $(".myModal2.on").removeClass("on");
                $(this).addClass("on");
                if(!this.hasClass("on")){}
            })

        })
    }
    function get_sell_detail_data(){
        var tishi = '';
        var names = [];
        var tr = $(".ta").find('table tbody tr[id="zz"]');
        var total_gold_weight=0;
        tr.each(function(){
            var id = $(this).find(".goods_id").find('input').val();
            if(id){
                var jjfs = $(this).find(".jijia").text();
                var sell_g_price = $(this).find(".sell_g_price").val();
                var gold_type = $(this).attr('gold_type');////贵金属金价类型id 暂时没有用到
                // var sell_m_fee = $(this).find(".goods_gram_price").find('input').val();
                var sell_m_fee = $.trim($(this).find(".goods_gram_price").text());
                var discount_price = $(this).find(".discount_price").find('input').val();
                var rell_sell_price = $(this).find(".goods_unit_price").find('input').val();
                var be_onsale_price = $(this).find(".be_onsale_price").text();
                var is_cut = $(this).find("select[name='is_cut']").val();
                var cut_weight = $(this).find("input[name='cut_weight']").val();
                var goods_weight = $(this).find("input[name='goods_weight']").val();
                //销售工费方式
                if(jjfs =='计件'){
                    var sell_feemode=0;
                }else {
                    var sell_feemode=$(this).attr('sell_feemode');
                }
                if(!rell_sell_price){
                    tishi = '销售价不能为空';
                    return;
                }
                if(goods_weight){
                    total_gold_weight=total_gold_weight+parseFloat(goods_weight);
                }
                names.push({
                    'id': id,
                    'be_onsale_price': be_onsale_price,
                    'discount_price': discount_price,
                    'sell_price': rell_sell_price,
                    'sell_m_fee': sell_m_fee,
                    'sell_pricemode': jjfs,
                    'sell_feemode':sell_feemode,
                    'sell_g_price': sell_g_price,
                    'gold_type': gold_type,
                    'is_cut': is_cut,
                    'cut_weight': cut_weight,
                    'goods_weight': goods_weight,
                });
            }
        })
        if (tishi) {
            $('.tishi').html(tishi);
            return false;
        }
        var post_data={total_product_gold_weight:total_gold_weight,names:names}
        return post_data;
    }
    function save(){
        $("#baocun,#submit").click(function(){
            var tishi = '';
            var store = $("#mobile").val();
            var uid = $('#uid').val();
            var employee_id = $('#employee_id').val();
            var recovery_wh_id=$("select[name='wh_id']").val();
            if(store.length <= 0 || (uid == '' && employee_id == '')){
                $('.tishi').html('会员姓名不能为空');
                artdialog_alert('会员姓名不能为空');
                return false;
            }
            var product_data=get_sell_detail_data();
            var names=product_data.names;
            var total_product_gold_weight=product_data.total_product_gold_weight;//货品克重
            /*change by alam 其它费用 2018/5/8 start*/
            // 其它费用
            var sub_datas = [];
            var sub_tr = $(".ta").find('table tbody[id="sub_tbody"] tr');
            sub_tr.each(function(){
                var expence_id = $(this).find(".expence_id").find('select').val();
                var sub_cost = $(this).find(".sub_price").find('input').val();
                if(expence_id != 0 && sub_cost == '') {
                    tishi = '其它费用费用金额不能为空';
                    return false;
                } else if(expence_id == 0 && sub_cost != '') {
                    tishi = '其它费用未选择费用类目';
                    return false;
                } else if(expence_id != 0 && sub_cost != '') {
                    sub_datas.push({
                        'expence_id': expence_id,
                        'sub_cost': sub_cost
                    });
                }
            })
            if (tishi) {
                $('.tishi').html(tishi);
                artdialog_alert(tishi);
                return false;
            }

            if(names.length < 1 && sub_datas.length < 1){
                $('.tishi').html('请选择需要销售的货品或填写其它费用');
                artdialog_alert('请选择需要销售的货品或填写其它费用');
                return false;
            }
            names = JSON.stringify(names);
            sub_datas = JSON.stringify(sub_datas);
            /*change by alam 其它费用 2018/5/8 end*/

            var saccout_record = getall_pay_type();
            if(saccout_record == false){
                return;
            }

            var order = {
                recovery_wh_id: $("select[name='wh_id']").val(),
                status: $(this).data('type'),
                client_idno: $("input[name='client_idno']").val(),
                sn_id: $("input[name='sn_id']").val(),
                sell_type: $("input[name='sell_type']:checked").val(),
                buyer_id: $('#uid').val(),
                employee_id: $('#employee_id').val(),
                count: $('#count').html(),
                sell_date: $('#sell_date').val(),
                remark: $("#remark").val(),
                extra_price: $("#extra_price").val(),
                main_currency_id:"{$currency[0]['id']}",
                main_currency_rate:"{$currency[0]['exchange_rate']}",
               /* main_currency_id:$("select[name='shop_id']").find("option:selected").attr("currency_id"),
                main_currency_rate:$("select[name='shop_id']").find("option:selected").attr("default_rate"),*/
            }

            var product_count = $("#total_num").text();
            var shop_id = $("select[name='shop_id']").val();
            var recovery_products = check_recovery_data();
           /* for(var i in recovery_products){
                var rproduct_obj = recovery_products[i];
                if(rproduct_obj.rproduct_code == ''){
                    $('.tishi').html('请输入第'+(i*1+1)+'个截金金料的金料编号');
                    artdialog_alert('请输入第'+(i*1+1)+'个截金金料的金料编号');
                    return false;
                }
            }*/
            var post_data = {
                store:store,
                order:order,
                product_count:product_count,
                shop_id:shop_id,
                order_detail:eval(names),
                sub_datas:eval(sub_datas),
                saccout_record:eval(saccout_record),
            };
            if(recovery_products.length>0){
                post_data.recovery_products=recovery_products;
            }
            //判断以旧换新信息内容是否正确
            //获取以旧换新信息
            var old_product_data=check_old_product_data();
            var total_recovery_gold_weight=old_product_data.total_recovery_gold_weight;//以旧换新克重
            var recovery_old_products=old_product_data.product_list;
            if(old_product_data){
                if(typeof(recovery_old_products)=='object'){
                    post_data.recovery_old_products=recovery_old_products;
                    if(total_product_gold_weight<total_recovery_gold_weight){
                        $('.tishi').html('以旧换新，旧金金重不能大于货品金重');
                        return false;
                    }
                }
            }else {
                return false;
            }
            if($('input[name="sell_type"]:checked').val()==2&&!post_data.recovery_old_products){
                $('.tishi').html('以旧换新的金料不能为空');
                artdialog_alert('以旧换新的金料不能为空');
                return false;
            }
            if(recovery_wh_id==0&&(post_data.recovery_old_products||post_data.recovery_products)){
                $('.tishi').html('金料仓库不能为空');
                artdialog_alert('金料仓库不能为空');
                return false;
            }
            var pay_price=parseFloat($("#count_price").text());
            var price=parseFloat($("#count").text());
            if(pay_price!=price){
                $('.tishi').html('收款总额与销售总额必须相等');
                artdialog_alert('收款总额与销售总额必须相等');
                return false;
            }
            $.ajax({
                url: "{:U('BSell/add')}",
                type: 'post',
                async: false,
                data: post_data,
                beforeSend: function() {
                    $(this).attr("disabled",true);
                },
                success: function(data) {
                    if(data.status == 1){
                        $('.tishi').html('操作成功');
                        location.href = data.url;
                    }else if(data.status == 0){
                        if(data.exist_rproduct_code){
                            var rproduct_codes=update_rproduct_code(data.rproduct_code_tr,data.rproduct_type);
                            $('.tishi').html(data.msg+'已自动变更为'+rproduct_codes);
                        }else {
                            $('.tishi').html(data.msg);
                        }
                        $(this).attr("disabled", false);
                        return false;
                    }
                },
                error: function (data,status) {
                    $(this).attr("disabled", false);
                }
            })
        });
    }
    function count_num(){
        var num=0;
        $(".ta").find('table tr').each(function(){
            if($(this).attr('id')=='zz'){
                num++;
            }
        });
        $('#total_num').html(num);
    }
    save();
    count();
    table_order();
</script>
<!--截金回购-->
<script>
    var cut_gold_price="{$price['cut_gold_price']}";
    //是否截取金切换触发事件
    function cutweight(){
        var sele = $('select[name=is_cut]');
        sele.unbind('change').change(function(){
            var tr=$(this).parent().parent();
            var product_code=$.trim(tr.find('.goods_code').text());
            var recovery_name= $.trim(tr.find('.goods_name').text());
            var purity=$.trim(tr.find('.goods_purity').text());
            //purity=purity.replace('‰','');
            var product_id=tr.find('#pid').val();

            if($(this).val()=='0'){
                // 截金：否
                $(this).closest('tr').find('.cut_weight').html('0.00<input type="hidden" product_code="'+ tr.find(".goods_code").text()+'" name="cut_weight" value="0.00" >');
                del_recovery_tr(product_code);
            } else{
                // 截金：是
                $(this).closest('tr').find('.cut_weight').html('<input type="text" autocomplete="off" product_code="'+ tr.find(".goods_code").text()+'" name="cut_weight" value="0.00" >');
                add_recovery_tr(product_code,product_id,purity,recovery_name);
            }
            table_order();
            change_td();

            var recovery_num = $('.recovery_tbody tr').length;
            if(recovery_num > 0){
                $('.recovery_wh_id').show();//金料仓库
                $('#recovery_table').show();//截金数据
            }else{
                if($('input[name=sell_type]:checked').val()==1){
                    $('.recovery_wh_id').hide();
                }
                $('#recovery_table').hide();
            }
        });
    }
    //添加一件截金信息
    function add_recovery_tr(product_code,product_id,purity,recovery_name){
        rproduct_code_num=parseInt(rproduct_code_num)+1;
        var str='000'+rproduct_code_num;
        var rproduct_code=day+str.substr(str.length-4);
        var html='<tr class="recovery_type_tr" product_code="'+product_code+'">';
        html+='<td class="text-center"></td>'
        html+='<td class="text-center product_code">'+product_code+'<input type="hidden" name="product_id" value="'+product_id+'" placeholder="货品id"></td>'
        html+='<td class="text-center recovery_name"><input type="text" autocomplete="off" name="recovery_name" value="'+recovery_name+'" ></td>'
        html+='<td class="text-center rproduct_code"><input type="text" readonly="readonly" autocomplete="off" name="rproduct_code" value="'+rproduct_code+'" ></td>'
        html+='<td class="text-center total_weight"><input type="number" autocomplete="off" name="total_weight" value="" placeholder="总重"></td>'
        /*html+='<td class="text-center gold_weight"><input type="number" autocomplete="off" name="gold_weight" value="" placeholder="金重"></td>'*/
        html+='<td class="text-center recovery_price" ><input type="number" autocomplete="off" name="recovery_price" value="'+cut_gold_price+'" placeholder="截金金价"></td>'
        html+='<td class="text-center service_fee"><input type="number" autocomplete="off" name="service_fee" value="" placeholder="服务克工费"></td>'
        html+='<td class="text-center purity" >'+purity+'<input type="hidden" name="purity" value="'+(purity/1000)+'" placeholder="纯度"></td>'
        /* html+='<td class="text-center attrition" ><input type="text" autocomplete="off" name="attrition" value="" placeholder="损耗"></td>'*/
        html+='<td class="text-center cost_price" ><input type="number" autocomplete="off" name="cost_price" value="" placeholder="抵扣费用"></td>'
        html += ' <td class="text-center td_material"><input type="text" step="0.01" autocomplete="off" name="material" class="material  no_arrow" value=""></td>';//材质
        html += ' <td class="text-center td_color"><input type="text" step="0.01" autocomplete="off" name="color" class="color  no_arrow" value=""></td>';//颜色
        html+='</tr>';
        $('.recovery_tbody').prepend(html);
        change_recovery_price();
    }
    //删除一条截金信息
    function del_recovery_tr(product_code){
        $('.recovery_tbody').find("tr[product_code='"+product_code+"']").remove();
        count_price2();
        //rproduct_code_num=parseInt(rproduct_code_num)-1;
    }
    //统计截金货品条数
    function count_recovery_num(){
        var num=0;
        $(".recovery_tbody").find('table tr').each(function(){
            if($(this).attr('id')=='zz'){
                num++;
            }
        });
        return num;
    }
    //统计截金成本价
    function count_price(){
        var price=0;
        $('.recovery_type_tr').find("input[name='cost_price']").each(function(key,val){
            if($(this).val()){
                price = parseFloat(price) + parseFloat($(this).val());
            }
        })
        return price.toFixed(2);
    }
    //计算截金金重
    function count_gold_weight(tr){
        var total_weight=tr.find('input[name="total_weight"]').val();
        var purity=tr.find('input[name="purity"]').val();
        var weight = total_weight;//*purity;
        return weight;
    }
    //成本价绑定keyup事件，成本价更改，改变总价
    function change_recovery_price() {
        $(".recovery_tbody input[name='cost_price']").unbind('keyup').keyup(function() {
            count_price2();
        })
    }
    //计算截金成本价
    function count_cost_price(tr){
        var cost_price=tr.find('input[name="cost_price"]');
        var gold_weight=count_gold_weight(tr);
        var recovery_price=tr.find('input[name="recovery_price"]').val();
        var service_fee=tr.find('input[name="service_fee"]').val();
        var cost_price=tr.find('input[name="cost_price"]');

        var price=gold_weight*(recovery_price*10000-service_fee*10000)/10000;
        cost_price.val(price.toFixed(2));
        count_price2();
    }
    //总重，纯度，损耗率 ，回购金价，克工费 改变 则改变金重和成本价
    function change_td(){
        $(".recovery_tbody input[name='total_weight'],.recovery_tbody input[name='recovery_price'],.recovery_tbody input[name='purity'],.recovery_tbody input[name='service_fee']").unbind('keyup').keyup(function(){
            var tr=$(this).parent().parent();
            count_cost_price(tr);
        })
    }
    //保存时，检测数据是否正确,并返回数据
    function check_recovery_data(){
        var product_list=[];
        var tr= $(".recovery_tbody").find('tr');
        tr.each(function(){
            var total_weight=$(this).find('input[name="total_weight"]').val();
            var rproduct_code = $(this).find('input[name="rproduct_code"]').val();
            var recovery_name = $(this).find('input[name="recovery_name"]').val();
            var recovery_price=$(this).find('input[name="recovery_price"]').val();
            var service_fee=$(this).find('input[name="service_fee"]').val();
            var purity=$(this).find('input[name="purity"]').val();
            var cost_price=$(this).find('input[name="cost_price"]').val();
            var product_id=$(this).find('input[name="product_id"]').val();
            var material = $(this).find('input[name="material"]').val();
            var color = $(this).find('input[name="color"]').val();
            product_list.push({
                'total_weight': total_weight,
                'recovery_name': recovery_name,
                'gold_weight': total_weight,
                'rproduct_code': rproduct_code,
                'recovery_price': recovery_price,
                'service_fee': service_fee,
                'purity': purity,
                'cost_price': cost_price,
                'product_id': product_id,
                'material' : material,
                'color' : color,
            });

        })
        return product_list;
    }
    //清空截金信息
    function clear_cut_product_info(){
        if($('.recovery_type_tr').length>1){
            $('.recovery_tbody').html('');
            $('#recovery_table').hide();
        }
    }
</script>
<!--截金回购 end-->
<!--切换门店触发事件-->
<script>
    //选择收货仓库，自动完善收货管理员信息
    var srcfirst=$("#goods_index").attr("src");
    $("select[name='shop_id']").change(function(){
        init_payment();//更改门店更改收款方式
        init_recovery_warehouse();//更改门店更改金料仓库
        localStorage.removeItem('p_id');//清空选中的货品id
        //清空列表中的货品
        if($(".sell_tbody").find('tr').length>2){
            var html='<tr id="last">';
            html+=$("#last").html();
            html+='</tr>';
            $(".sell_tbody").html(html);//清空列表中的货品
        }
        clear_cut_product_info();//清空截金信息
        clear_sub_info();//清空其他费用信息
        clear_old_product_info();//清空以旧换新信息
        clear_pay_info();//清空收款方式信息
        table_order();//table重新排序
        count_price2();//更新收款金额
        //切换门店货品列表
        var src=srcfirst+"&shop_id="+$("select[name='shop_id']").val();
        $("#goods_index").attr("src",src);
        /*//切换默认汇率
        var default_exchange_rate=$("select[name='shop_id']").find("option:selected").attr("default_rate");
        if(!default_exchange_rate){
            default_exchange_rate=100.00;
        }
        $(".default_rate").text(default_exchange_rate);
        //切换默认币种
        var count_unit=$("select[name='shop_id']").find("option:selected").attr("unit");
        if(!count_unit){
            count_unit="元";
        }
        $(".count_unit").text(count_unit);*/
    })
</script>
<!--change by alam 2018/5/8 其它费用 start-->
<script>
    //清空其他费用信息
    function clear_sub_info(){
        if($('#sub_tbody').find('tr').length>2){
            var html='<tr id="sub_last">';
            html+=$("#sub_last").html();
            html+='</tr>';
            $('#sub_tbody').html(html);
        }
    }
    //添加一列其它费用
    function add_sell_sub(){
        $("#sub_add").unbind('click').click(function () {
            var expence_html=$("#expence_html").html();
            var html='<tr>';
            html+='<td class="text-center"></td>';
            html+='<td class="text-center expence_id">'+expence_html+'</td>';
            html+='<td class="text-center sub_price"><input type="number" autocomplete="off" class="sub_cost" step="0.01" value="" placeholder="类目金额" style="width:220px;"></td>';
            html+='<td class="text-center" id="sub_add" role="button" style="cursor:pointer;"><a href="javascript:void(0);">+</a></td>';
            html+='</tr>';
            $("#sub_add").addClass('sub_del');
            $("#sub_add").find('a').html('删除');
            $("#sub_add").removeAttr('id');
            $("#sub_tbody").append(html);
            table_order();
            count();
            add_sell_sub();
            del_sell_sub();
        })
    }
    //删除收款记录
    function del_sell_sub() {
        $(".sub_del").unbind("click").click(function(){
            var tr = $(this).parent("tr");
            var price = tr.find('td').find('input').val();
            var count = $('#count').html();
            if(price){
                if(count != '' && count != NaN){
                    count =(parseFloat(count) - parseFloat(price)).toFixed(2);
                }
            }
            $('#total_price').val(count);
            tr.remove();
            table_order();
            change_countprice();
            change_needprice();
            count_price2();
        });
    }
    add_sell_sub();
</script>
<!--change by alam 2018/5/8 其它费用 end-->
<!--改变门店则改变客户列表-->
<!--<script>
    var client_list_src=$("#goods_index2").attr("src");
    $('#shop').change(function(){
        var src=client_list_src+"&shop_id="+$("#shop").val();
        $("#goods_index2").attr("src",src);
    })
</script>-->
<!-- 会员操作弹窗联动js -->
<script type="text/javascript">
    function loadFrame(obj){
        var url = obj.contentWindow.location.href;
        if(url.indexOf("{:U('BSell/client_list')}")!=-1){
            $('#clientModalLabel').text('选择会员');
        }else if(url.indexOf("{:U('BSell/add_client')}")!=-1){
            $('#clientModalLabel').text('添加会员');
        }
    }
</script>
<!--门店改变，改变收款方式  -->
<script>
    //初始化收款方式
    init_payment();
    //更改门店更改收款方式
    function init_payment(){
        var payments='{$payment}';
        var job_html='<option value="0" >选择收款方式</option>';
        var change_select=$('select[name=pay_id]');
        var sector_obj= $('select[name=shop_id]');
        get_payment(payments,sector_obj,change_select,job_html);
    }
    /**
     *
     * @param payments 所有的收款方式
     * @param sector_id  选择的门店的id
     * @param change_select 需要联动改变的select对象
     * @param job_html     select对象的html内容
     */
    function get_payment(payments,sector_obj,change_select,job_html){
        var payments_json=eval(payments);
        var sector_id=sector_obj.val();
        var common_payment=sector_obj.find("option:selected").attr('show_common_payment');
        $.each(payments_json, function (n, v) {
            if(sector_id== v.shop_id||(v.shop_id==0&&common_payment=='1')){
                job_html+='<option value="'+ v.id+'" pay_type="'+v.pay_type+'">'+ v.pay_name+'</option>';
            }
        });
        change_select.html(job_html);
    }
</script>
<!--门店改变，改变收款方式  end-->
<!--以旧换新-->
<script>
    //销售类型切换
    $('input[name="sell_type"]').unbind('change').change(function(){
        //以旧换新
        if($(this).val()==2){
            $('.recovery_wh_id').show();//金料仓库
            $('#recovery_old_product').show();//以旧换新数据
            $('.client_idno').show();//身份证号
        }else{
            if($('.recovery_type_tr').length==0){
                $('.recovery_wh_id').hide();
            }
            $('#recovery_old_product').hide();
            $('.client_idno').hide();//身份证号
        }
    })
    //添加一行旧金
    $("#add_old_product").unbind("click").click(function() {
        var gold_price = "{$price['gold_price']}";
        var recovery_price = "{$price['recovery_price']}";
        rproduct_code_num=parseInt(rproduct_code_num)+1;
        var str='000'+rproduct_code_num;
        var rproduct_code=day+str.substr(str.length-4);
        var html = '';
        html += '<tr id="old_product_tr" class="old_product_tr">';
        html += '<td class="text-center"></td>';//序
        html += ' <td class="text-center td_recovery_name"><input type="text" autocomplete="off" name="recovery_name" class="recovery_name" value=""></td>';
        html += ' <td class="text-center td_rproduct_code"><input type="text" readonly="readonly" autocomplete="off" name="rproduct_code" class="rproduct_code" value="'+rproduct_code+'"></td>';
        html += ' <td class="text-center td_total_weight"><input type="number" step="0.001" autocomplete="off" name="total_weight" class="total_weight input_init no_arrow" value="0.00"></td>';//总重
        html += ' <td class="text-center td_purity"><input type="number" step="0.001" autocomplete="off" name="purity" class="purity no_arrow" placeholder="999.9"></td>';//纯度
        html += ' <td class="text-center td_gold_weight"><input type="number" step="0.001"autocomplete="off" name="gold_weight" class="gold_weight input_init no_arrow" value="0.00"></td>';//金重
        html += ' <td class="text-center td_recovery_price"><input type="number" step="0.01" autocomplete="off" name="recovery_price" class="recovery_price no_arrow" value="'+recovery_price+'"></td>';//回购金价
        html += ' <td class="text-center td_gold_price"><input type="number" step="0.01" autocomplete="off" name="gold_price" class="gold_price no_arrow" value="'+gold_price+'"></td>';//当前金价
        html += ' <td class="text-center td_service_fee"><input type="number" step="0.01" autocomplete="off" name="service_fee" class="service_fee input_init no_arrow" value=""></td>';//服务克工费
        //html += ' <td class="text-center td_attrition"><input type="number" step="0.001" autocomplete="off" name="attrition" class="attrition input_init no_arrow" value="0.00"></td>';//损耗率
        html += ' <td class="text-center td_cost_price"><input type="number" step="0.01" autocomplete="off" name="cost_price" class="cost_price input_init no_arrow" value="0.00"></td>';//成本价
        html += ' <td class="text-center td_material"><input type="text" step="0.01" autocomplete="off" name="material" class="material  no_arrow" value=""></td>';//材质
        html += ' <td class="text-center td_color"><input type="text" step="0.01" autocomplete="off" name="color" class="color  no_arrow" value=""></td>';//颜色
        html += '<td class="text-center">'
        html += '<a href="javascript:void(0);" name="{$v.id}"  class="old_product_del" >删除</i></a>';
        html += '</td>';
        html += '</tr>';
        $("#old_product_last").before(html);
        table_order();
        old_product_del();
        change_old_product_td();
        change_old_product_price();
    });
    //给删除按钮添加删除事件
    function old_product_del() {
        $(".old_product_del").unbind("click").click(function() {
            var tr = $(this).parent().parent();
            tr.remove();
            table_order();
            //rproduct_code_num=parseInt(rproduct_code_num)-1;
        });
    }
    //成本价绑定keyup事件，成本价更改，改变总价
    function change_old_product_price() {
        $("#old_product_tbody input[name='cost_price']").unbind('keyup').keyup(function() {
            count_price2();
        })
    }

    //总重，纯度，损耗率 ，回购金价，克工费 改变 则改变金重和成本价
    function change_old_product_td() {
        $("#old_product_tbody input[name='total_weight'],#old_product_tbody input[name='recovery_price'],#old_product_tbody input[name='purity'],#old_product_tbody input[name='service_fee']").unbind('keyup').keyup(function() {
            var tr = $(this).parent().parent();
            count_old_product_cost_price(tr);
        })
    }
    //计算每条旧金成本价
    function count_old_product_cost_price(tr) {
        var cost_price = tr.find('input[name="cost_price"]');
        var gold_weight = count_old_product_weight(tr);
        var recovery_price = tr.find('input[name="recovery_price"]').val();
        var service_fee = tr.find('input[name="service_fee"]').val();
        var cost_price = tr.find('input[name="cost_price"]');
        var price = gold_weight * (recovery_price * 10000 - service_fee * 10000) / 10000;
        cost_price.val(price.toFixed(2));
        count_price2();
    }
    //统计所有旧金成本价 用于更改总的销售金额
    function count_old_product_price() {
        var price = 0;
        $('#old_product_tr td .cost_price').each(function(key, val) {
            if ($(this).val()) {
                price = parseFloat(price) + parseFloat($(this).val());
            }
        })
        return price;
    }
    // 计算金重 [change by alam 2018/5/15 this function]
    function count_old_product_weight(tr) {
        var total_weight = parseFloat(tr.find('input[name="total_weight"]').val());
        var gold_weight = tr.find('input[name="gold_weight"]');
        var purity = parseFloat(tr.find('input[name="purity"]').val());
        purity = purity / 1000;
        //var attrition = tr.find('input[name="attrition"]').val();
        var weight = total_weight * purity ;
        gold_weight.val(weight.toFixed(2));
        return weight.toFixed(2);
    }
    // 比较旧金金重和购买的货品总重
    function compare_weight() {

    }
    //清空以旧换新信息
    function clear_old_product_info(){
        if($('.old_product_tr').length>1){
            var html='<tr id="last">';
            html+=$('#old_product_last').html();
            html+='</tr>';
            $('#old_product_tbody').html(html);
            $('#recovery_old_product').hide();
        }
    }
    //保存时，检测数据是否正确,并返回数据
    function check_old_product_data() {
        is_true = true;
        var product_list = [];
        var tr = $(".old_product_tr");
        if (tr.length < 1) {
            return true;
        }
        var i = 0;
        var total_gold_weight=0;
        tr.each(function() {
            i++;
            var recovery_name = $(this).find('input[name="recovery_name"]').val();
            var rproduct_code = $(this).find('input[name="rproduct_code"]').val();
            var product_code = $(this).find('input[name="product_code"]').val();
            var total_weight = $(this).find('input[name="total_weight"]').val();
            var gold_weight = $(this).find('input[name="gold_weight"]').val();
            var recovery_price = $(this).find('input[name="recovery_price"]').val();
            var gold_price = $(this).find('input[name="gold_price"]').val();
            var service_fee = $(this).find('input[name="service_fee"]').val();
            var purity = $(this).find('input[name="purity"]').val();
            /*var attrition = $(this).find('input[name="attrition"]').val();*/
            var cost_price = $(this).find('input[name="cost_price"]').val();
            var type = $(this).find('select[name="type"]').val();
            var sn_id = $(this).find('#product_id').val();
            var material = $(this).find('input[name="material"]').val();
            var color = $(this).find('input[name="color"]').val();
            /*change by alam 2018/5/15 start*/
            if (purity > 1000) {
                is_true = false;
                $('.tishi').html("第" + i + "行以旧换新纯度必须小于1000");
                artdialog_alert("第" + i + "行以旧换新纯度必须小于1000");
                return false;
            }
            purity = parseFloat(purity / 1000).toFixed(6);
            /*change by alam 2018/5/15 end*/

            if (empty(recovery_name)) {
                is_true = false;
                $('.tishi').html("第" + i + "行以旧换新金料名称");
                artdialog_alert("第" + i + "行以旧换新金料名称");
                return false;
            }

           /* if (empty(rproduct_code)) {
                is_true = false;
                $('.tishi').html("第" + i + "行以旧换新金料编号");
                artdialog_alert("第" + i + "行以旧换新金料编号");
                return false;
            }*/

            product_list.push({
                'recovery_name' : recovery_name,
                'rproduct_code' : rproduct_code,
                'total_weight' : total_weight,
                'gold_weight' : gold_weight,
                'recovery_price' : recovery_price,
                'gold_price' : gold_price,
                'service_fee' : service_fee,
                'purity' : purity,
                'cost_price' : cost_price,
                'type' : type,
                'product_id' : sn_id,
                'material' : material,
                'color' : color
            });
            total_gold_weight=total_gold_weight+parseFloat(gold_weight);
        })
        if (is_true) {
            var post_data = {
                'total_recovery_gold_weight' : total_gold_weight,
                'product_list' : eval(product_list)
            }
        } else {
            var post_data = false;
        }
        return post_data;
    }

</script>
<!--门店改变，改变金料仓库 -->
<script>
    //初始化收款方式
    init_recovery_warehouse();
    //更改门店更改收款方式
    function init_recovery_warehouse(){
        var datas='{$warehouse}';
        var job_html='<option value="0" >选择仓库</option>';
        var change_select=$('select[name=wh_id]');
        var sector_obj= $('select[name=shop_id]');
        get_recovery_warehouse(datas,sector_obj,change_select,job_html);
    }
    /**
     *
     * @param datas 所有的数据
     * @param sector_id  选择的门店的id
     * @param change_select 需要联动改变的select对象
     * @param job_html     select对象的html内容
     */
    function get_recovery_warehouse(datas,sector_obj,change_select,job_html){
        var datas_json=eval(datas);
        console.log(datas_json);
        var sector_id=sector_obj.val();
        $.each(datas_json, function (n, v) {
            if(sector_id== v.shop_id){
                job_html+='<option value="'+ v.id+'" >'+ v.wh_name+'</option>';
            }
        });
        change_select.html(job_html);
    }
</script>
<!--门店改变，改变金料仓库  end-->