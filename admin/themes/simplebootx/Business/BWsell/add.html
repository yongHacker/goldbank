<businesstpl file="header" />
<style type="text/css">
	.table .search_input{
		margin: 0;
		padding: 0;
		position: relative;
	}
	#mobile{
		margin:8px 5px;
		text-indent: 20px;
	}
	.myModal3.leave{
		position: absolute;
		top:12px;
		left:15px;
		font-size: 14px;
	}
    .ta select,.ta input{
        width: 90%;
    }
</style>
</head>
<body class=" theme-blue">
<div class="wrap js-check-wrap"  >
	<ul class="nav nav-tabs">
		<!--<li><a href="{:U('sells/index')}">销售列表</a></li>-->
		<li class="active"><a href="{:U('BWsell/add')}">{:L('BUSINESS_BWsell_ADD')}</a></li>
	</ul>
	<table class="table table-bordered" id="order_base">
		<tr>
			<td class="sel" width="20%">日期</td>
			<td width="25%">
			{$today}
			</td>
			<!--<td class="sel" width="20%">会员姓名</td>
			<td class="search_input" width="25%">
				<input  type="text" id="mobile"  class="form-control" onclick="$('#myModal3').modal('show');"> &lt;!&ndash;style="display: none;"&ndash;&gt;
				<input type="hidden" id="uid"  class="form-control" value="">
				<a href="#myModal3" class="myModal3 leave" data-toggle="modal" name="{$v.id}" role="button"><span><i class="fa fa-search normal"></i></span></a>
			</td>-->
            <td class="sel">经销商</td>
            <td>
                <select id="company_name">
                    <option value="">--请选择--</option>
                    <volist name="supplier_info" id="v">
                        <option value="{$v.id}">{$v.company_name}</option>
                    </volist>
                </select>  <span class="form-required">*</span>
            </td>
		</tr>
		<tr>
			<td class="sel">销售员</td>
			<td width="25%" >{$user_nicename}</td>
			<td class="sel">销售数量</td>
			<td width="25%" id="total_num"></td>
		</tr>
        <tr>
            <td class="sel">门店</td>
            <td width="25%" >
                <select id="shop" name="shop_id" data-live-search="true">
                    <option value="0" checked default_rate="{$currency[0]['exchange_rate']}" unit="{$currency[0]['unit']}">总部</option>
                   <!-- <volist name="shop" id="v">
                            <option value="{$v.id}" in_user="{$v.user_nicename}" unit="{$v.unit}" default_rate="{$v.exchange_rate}"  checked>{$v.shop_name}</option>
                    </volist >-->
                </select>
            </td>
            <td class="sel" style="border-bottom: 1px solid #ddd;" class="gold">销售总价</td>
            <td width="25%" style="border-bottom: 1px solid #ddd;"><input id="count" type="text" style="margin-bottom:0px;" value=""></td>
        </tr>
		<tr>
			<td class="sel">备注</td>
			<td width="25%" ><textarea type="text" id="remark"></textarea></td>
		</tr>
	</table>
	<div class="main-content" >
		<div class="ta" id="order_product" style="overflow-x: auto;">
			<table class="table table-bordered  table-hover" >
				<thead >
				<tr>
					<th>序</th>
					<th style="width: 160px;">品目编号</th>
					<th>品目</th>
					<th>规格</th>
                    <th style="width: 80px;">售价单价</th>
                    <th style="width: 80px;">销售量</th>
                    <th style="width: 80px;">计量单位</th>
                    <th style="width: 80px;">工费</th>
                    <th style="width: 80px;">单品优惠</th>
					<th style="width: 80px;">销售价</th>
					<th>计价方式</th>
					<th hidden="hidden">id</th>
					<th >操作</th>
				</tr>
				</thead>
				<tbody id="tbody">
				<tr id="last">
					<td class="text-center"></td>
					<td class="text-center"></td>
					<td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
					<td class="text-center"></td>
					<td class="text-center"></td>
                    <td class="text-center"></td>
                    <td class="text-center"></td>
					<td class="text-center"></td>
					<td class="text-center myModal2 on" href="#myModal2" style="cursor:pointer;" data-toggle="modal" role="button"><a href="javascript:void(0);">+</a></td>
				</tr>
				</tbody>
			</table>
		</div>
        <ul class="nav nav-tabs" style="display: none">
            <li class="active"><a href="javascript:void(0);">收款明细</a></li>
        </ul>
       <p style="display: none"> 默认币种：<span class="count_unit">{$currency[0]['currency_name']}</span>&nbsp;&nbsp;&nbsp;汇率：<span class="default_rate">{$currency[0]['exchange_rate']}</span>‰</p>
        <div class="ta" style="display: none">
            <table class="table table-bordered  table-hover">
                <thead >
                <tr>
                    <th>序</th>
                    <th style="width:220px;">收款方式</th>
                    <th >币种</th>
                    <th style="width:220px;">流水号</th>
                    <th >收款金额</th>
                    <th style="width:220px;">计算单位</th>
                    <th style="width:220px;">汇率％</th>
                    <th >收款类型</th>
                    <th style="width:220px;">计算金额</th>
                    <th style="width:160px;">操作</th>
                </tr>
                </thead>
                <tbody id="tbody" class="pay_tbody">
                <tr id="last" class="pay_type_tr">
                    <td class="text-center"></td>
                    <td class="text-center pay_id">
                        <select name="pay_id"  >
                            <option value="0" pay_type="{$vo.pay_type}">选择收款方式</option>
                            <volist name="payment" id="vo">
                                <option value="{$vo.id}" pay_type="{$vo.pay_type}">{$vo.pay_name}</option>
                            </volist>
                        </select>
                    </td>
                    <td class="text-center currency" >
                        <select name="currency" >
                            <option value="0" >选择币种</option>
                            <volist name="currency" id="vo">
                                <option value="{$vo.id}" exchange_rate="{$vo.exchange_rate}" unit="{$vo.unit}">{$vo.currency_name}</option>
                            </volist>
                        </select>
                    </td>
                    <td class="text-right flow_id"><input type="text" autocomplete="off" name="flow_id" value="" placeholder="流水号"></td>
                    <td class="text-right pay_price"><input type="text" autocomplete="off" name="pay_price" value="0"></td>
                    <td class="text-center unit" ></td>
                    <td class="text-center exchange_rate" ></td>
                    <td class="text-center pay_type" ></td>
                    <td class="text-center actual_price" >0.00</td>
                    <td class="text-center" id="add_pay_type" style="color: #3daae9;cursor:pointer;" >+添加收款方式</td>
                </tr>
                <tr id="count_pay">
                    <td class="text-center"></td>
                    <td class="text-center" colspan="3">计算金额=收款金额*汇率/默认汇率</td>
                    <td class="text-center" colspan="3">总计：<span id="count_price">0.00</span><span class="count_unit">{$currency[0]['unit']}</span></td>
                    <td class="text-center" colspan="3">还需支付：<span id="need_price">0.00</span><span  class="count_unit">{$currency[0]['unit']}</span></td>
                   <!-- <td class="text-center" colspan="5">还需支付：<span id="need_price">0.00</span>{$currency[0]['unit']}</td>-->
                </tr>
                </tbody>
            </table>
            <!--收款方式html-->
            <div id="pay_html" hidden="hidden">
                <select name="pay_id"  >
                    <option value="0" pay_type="0">选择收款方式</option>
                    <volist name="payment" id="vo">
                        <option value="{$vo.id}" pay_type="{$vo.pay_type}">{$vo.pay_name}</option>
                    </volist>
                </select>
            </div>
            <!--币种方式html-->
            <div id="currency_html" hidden="hidden">
                <select name="currency"  >
                    <option value="0" >选择币种</option>
                    <volist name="currency" id="vo">
                        <option value="{$vo.id}" exchange_rate="{$vo.exchange_rate}" unit="{$vo.unit}">{$vo.currency_name}</option>
                    </volist>
                </select>
            </div>
        </div>
		<div class="form-actions">
			<div class="center-block" style="width:260px; margin: 0 auto;">
				<button type="button" class="btn btn-primary baocun" id="baocun">{:L('SAVE')}</button>
				<div class="tishi" style="color: red;"></div>
				<div>
				</div>
				<div class="modal small fade" style="width:80%;left:400px;top:2%;bottom: 2%;display:none" id="myModal2" hidden=hidden tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
								<b id="myModalLabel" style="margin: 0;font-family: 'Microsoft Yahei', verdana;color: #157ab5;">商品列表</b>
							</div>
							<div class="modal-body" style="max-height: 500px;padding: 0px;margin:0px">
								<iframe  frameborder="0" class="appiframe" src="{:U('BWsell/product_list')}" id="goods_index" name="goods_index">

								</iframe>
							</div>
							<div class="modal-footer">
								<button id="check" class="btn btn-primary pull-left" >选中</button>
								<button id="cancel" class="btn btn-default" data-dismiss="modal" aria-hidden="true">返回</button>
								<button id="add" class="btn btn-primary" data-dismiss="modal">选中并关闭</button>
							</div>
						</div>
					</div>
				</div>

				<div class="modal small fade" style="width:80%;left: 400px;top:2%;bottom: 2%;display:none" id="myModal3" hidden=hidden tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
					<div class="modal-dialog">
						<div class="modal-content">
							<div class="modal-header">
								<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
								<b id="myModalLabel" style="margin: 0;font-family: 'Microsoft Yahei', verdana;color: #157ab5;">选择会员</b>
							</div>
							<div class="modal-body" style="max-height: 500px;padding: 0px;">
								<iframe  frameborder="0" class="appiframe" src="{:U('BWsell/client_list')}" id="goods_index2" name="goods_index2">

								</iframe>

							</div>
							<div class="modal-footer">
								<button id="cancel" class="btn btn-default" data-dismiss="modal" aria-hidden="true">返回</button>
								<button id="add-2" class="btn btn-primary" data-dismiss="modal">选中</button>
							</div>
						</div>
					</div>
				</div>
				<script src="__PUBLIC__/lib/bootstrap/js/tree.js"></script>
				<script src="__PUBLIC__/js/common.js"></script>
				<script src="__PUBLIC__/js/jquery-ui.min.js"></script>
                <!--收款方式-->
                <script>
                    /*localStorage.removeItem('sell_name');
                    localStorage.removeItem('sell_mobile');
                    localStorage.removeItem('sell_uid');*/
                    //获取收款列表数据
                    function getall_pay_type(){
                        var is_true=true;
                        var datas = [];
                        var tr= $(".ta").find('table tbody tr[class="pay_type_tr"]');
                        console.log(tr.length)
                        var i=1;
                        tr.each(function(){
                            var pay_id =$(this).find(".pay_id").find('select').val();
                            var currency=$(this).find(".currency").find('select').val();
                            var flow_id =$(this).find(".flow_id").find('input').val();
                            var pay_price =$(this).find(".pay_price").find('input').val();
                            var actual_price =$(this).find(".actual_price").text();
                            if(!pay_id||pay_id==0){
                                $('.tishi').html('第'+i+'行未选择收款方式');
                                is_true=false;
                                return false;
                            }
                            if(!currency||currency==0){
                                $('.tishi').html('第'+i+'行未选择币种');
                                is_true=false;
                                return false;
                            }
                            if(!pay_price||pay_price==0){
                                $('.tishi').html('第'+i+'行未填写金额');
                                is_true=false;
                                return false;
                            }
                            i=i+1;
                            if(actual_price&&currency&&pay_id){
                                datas.push({
                                    'pay_id': pay_id,
                                    'flow_id': flow_id,
                                    'currency': currency,
                                    'pay_price': pay_price,
                                    'actual_price': actual_price
                                });
                            }
                        });
                        if(is_true){
                            return JSON.stringify(datas);
                        }else {
                            return false;
                        }

                    }
                    //删除收款记录
                    function del_pay_type() {
                       $(".pay_del").unbind("click").click(function(){
                           $(this).parent("tr").remove();
                           change_countprice();
                           change_needprice();
                       });
                    }
                    //总金额修改或收款金额修改
                    function change_pay_price() {
                        $("#count").unbind('change').change(function () {
                            change_needprice();
                        })
                        $("input[name='pay_price']").unbind('keyup').keyup(function () {
                            change_countprice();
                            change_needprice();
                        });
                    }
                    //修改还需支付的金额
                    function change_needprice(){
                        var count_price=$("#count_price").text();
                        var count=$("#count").val();
                        var need_price=count-count_price;
                        $("#need_price").text(need_price.toFixed(2));
                    }
                    //修改已经支付的金额和计算金额
                    function change_countprice(){
                        //默认币种汇率
                        var shop_id=$("select[name='shop_id']").val();
                        if(shop_id==0){
                            var default_exchange_rate="{$currency[0]['exchange_rate']}";
                            if(!default_exchange_rate){
                                default_exchange_rate=100;
                            }
                        }else {
                            var default_exchange_rate=$("select[name='shop_id']").find("option:selected").attr("default_rate");
                            if(!default_exchange_rate){
                                default_exchange_rate=100;
                            }
                        }

                        var con=0;
                        $("input[name='pay_price']").each(function(key,val){
                            var pay_price=$(this).val();
                            var  actual_price=0;
                            if(pay_price==''){
                                pay_price=0;
                            }else {
                                var exchange_rate =$(this).parent().parent().find(".exchange_rate").text();
                                var actual_price=pay_price*(exchange_rate)/default_exchange_rate;
                                console.log(pay_price+"//"+exchange_rate+"//"+default_exchange_rate);
                            }
                            actual_price=actual_price.toFixed(2);
                            $(this).parent().parent().find(".actual_price").text(actual_price);
                            con = parseFloat(con) + parseFloat(actual_price);
                        })
                        $("#count_price").text(con.toFixed(2));
                    }
                    //修改收款方式
                    function change_pay_type(){
                        $(".pay_id").find("select[name='pay_id']").unbind('change').change(function () {
                            var pay_type=$(this).find("option:selected").attr("pay_type");
                            if(pay_type>0){
                                $(this).parent().parent().find(".pay_type").text("系统内支付");
                            }else {
                                $(this).parent().parent().find(".pay_type").text("系统外支付");
                            }
                        })
                    }
                    //币种选取，修改币种参数以及计算金额和已经支付金额，还需支付金额
                    function change_exchange_rate(){
                        $(".currency").find("select[name='currency']").unbind('change').change(function () {
                            var exchange_rate=$(this).find("option:selected").attr("exchange_rate");
                            var unit=$(this).find("option:selected").attr("unit");
                            $(this).parent().parent().find(".exchange_rate").text(exchange_rate);
                            $(this).parent().parent().find(".unit").text(unit);
                            //默认币种汇率
                            var shop_id=$("select[name='shop_id']").val();
                            if(shop_id==0){
                                var default_exchange_rate="{$currency[0]['exchange_rate']}";
                                if(!default_exchange_rate){
                                    default_exchange_rate=100;
                                }
                            }else {
                                var default_exchange_rate=$("select[name='shop_id']").find("option:selected").attr("default_rate");
                                if(!default_exchange_rate){
                                    default_exchange_rate=100;
                                }
                            }
                            var pay_price=$(this).parent().parent().find("input[name='pay_price']").val();
                            var actual_price=pay_price*exchange_rate/default_exchange_rate;
                            actual_price=actual_price.toFixed(2);
                            $(this).parent().parent().find(".actual_price").text(actual_price);
                            change_countprice();
                            change_needprice();
                        })
                    }
                    //添加一列收款记录
                    function add_pay_type(){
                        $("#add_pay_type").unbind('click').click(function () {
                            var pay_id_html=$("#pay_html").html();
                            var currency_html=$("#currency_html").html();
                            var html='<tr class="pay_type_tr">';
                            html+='<td class="text-center"></td>';
                            html+='<td class="text-center pay_id">'+pay_id_html+'</td>';
                            html+='<td class="text-center currency">'+currency_html+'</td>';
                            html+='<td class="text-right flow_id"><input type="text" autocomplete="off" name="flow_id" value="" placeholder="流水号"></td>';
                            html+='<td class="text-right pay_price"><input type="text" autocomplete="off" name="pay_price" value="0" placeholder="收款金额"></td>';
                            html+='<td class="text-center unit"></td>';
                            html+='<td class="text-center exchange_rate"></td>';
                            html+='<td class="text-center pay_type"></td>';
                            html+='<td class="text-center actual_price">0.00</td>';
                            html+='<td class="text-center pay_del" style="color: #3daae9;cursor:pointer;">删除</td>';
                            html+='</tr>';
                            $(".pay_tbody").find("#last").before(html);
                            table_order();
                            change_pay_type();
                            change_exchange_rate();
                            change_pay_price();
                            del_pay_type();
                        })
                    }
                    change_pay_type();
                    add_pay_type();
                    change_exchange_rate();
                    change_pay_price();
                </script>
				<script type="text/javascript">
                    localStorage.removeItem('p_id');
                    $("#myModal3").on("shown.bs.modal",function () {
                        $("#goods_index2").contents().find("#mobile").focus();
                    })
                    //销售总价
                    function count_price2(){
                        var con=0;
                        $('tr td .price2').each(function(key,val){
                            if($(this).val()){
                                con = parseFloat(con) + parseFloat($(this).val());
                            }
                        })
                        $('#count').val(con.toFixed(2));
                        $('#total_price').val(con.toFixed(2));
                        change_needprice();
                    }
                    //销售价改变销售总价
                    function count(){
                        $("input[class='price2']").unbind('keyup').keyup(function(){
                            count_price2();
                        })
                    }
                    //优惠价改变销售价和销售总价
                    function discount_price(){
                        $("input[class='discount_price']").unbind('keyup').keyup(function(){
                            var tr=$(this).parent().parent();
                            var gold = parseFloat(tr.find('.gold_price').find('input').val());//金价
                            var  m_fee = parseFloat(tr.find('.sell_fee').find('input').val())>0?tr.find('.sell_fee').find('input').val():0;//工费
                            var g = tr.find('.num_stock').find('input').val();//销售量
                            //计价
                            var sell_price = tr.find('.goods_unit_price').find('input').attr("price");//销售价
                            var price2 = ((parseFloat(sell_price)+parseFloat(m_fee)-$(this).val()) * g).toFixed(2);//应售价-
                            tr.find('.goods_unit_price').find('input').val(price2);
                            count_price2();
                        })
                    }
                    //工费改变销售总价
                    function m_frr(){
                        $("input[class='sell_fee']").unbind('keyup').keyup(function(){
                            var tr=$(this).parent().parent();
                            var gold = parseFloat(tr.find('.gold_price').find('input').val());//金价
                            var  discount_price = parseFloat(tr.find('.discount_price').find('input').val())>0?tr.find('.discount_price').find('input').val():0;//工费
                            var g = tr.find('.num_stock').find('input').val();//销售量
                            var m_fee=$(this).val();
                            console.log(m_fee);
                            //计价
                            var sell_price = tr.find('.goods_unit_price').find('input').attr("price");//销售价
                            var price2 = ((parseFloat(sell_price)+parseFloat(m_fee)-parseFloat(discount_price)) * g).toFixed(2);//应售价-
                            tr.find('.goods_unit_price').find('input').val(price2);
                            count_price2();
                        })
                    }
                    function num_stock(){

                        $("input[class='num_stock']").unbind('keyup').keyup(function(){
                            console.log( $(this).attr("num_stock")+"//"+$(this).val());
                            if(parseFloat($(this).attr("num_stock"))<parseFloat($(this).val())){
                                artdialog_alert("销售量不能大于库存量！");
                            }
                            if(parseFloat($(this).val())<=0){
                                artdialog_alert("销售量不能为空！");
                            }
                            var tr=$(this).parent().parent();
                            var gold = parseFloat(tr.find('.gold_price').find('input').val());//金价
                            var  discount_price = parseFloat(tr.find('.discount_price').find('input').val())>0?tr.find('.discount_price').find('input').val():0;//工费
                            var  m_fee = parseFloat(tr.find('.sell_fee').find('input').val())>0?tr.find('.sell_fee').find('input').val():0;//工费
                            var g = $(this).val()//销售量
                            //计价
                            var sell_price = tr.find('.goods_unit_price').find('input').attr("price");//销售价
                            var price2 = ((parseFloat(sell_price)+parseFloat(m_fee)-parseFloat(discount_price)) * g).toFixed(2);//应售价-
                            tr.find('.goods_unit_price').find('input').val(price2);
                            count_price2();
                        })
                    }
                    var tr_order=1;
                    table_order();
                    function table_order(){
                        var len = $(".ta").find('table tr').length;
                        for(var i = 1;i<len;i++){
                            $(".ta").find('table tr:eq('+i+') td:first').text(i);
                        }
                        count_num();
                    }
                    function del(){
                        $(".del").click(function(){
                            tr.remove();
                        });
                    }
                    function del_input(){
                        //删除tr
                        $(".del").each(function(){
                            $(this).click(function(){
                                var tr=$(this).parent().parent();
                                tr.remove();
                                table_order();
                                var price = tr.find('.goods_unit_price').find('input').val();
                                var count = $('#count').val();
                                if(price){
                                    if(count !='' && count != NaN){
                                        count2 =(parseFloat(count)-parseFloat(price)).toFixed(2);
                                    }
                                }
                                $('#count').val(count2);
                                $('#total_price').val(count2);
                                var checked=localStorage.getItem('p_id');
                                var p_id=tr.find(".wgoods_stock_id").find("input").val();
                                checked=checked.replace("ck"+p_id+"ck","");
                                localStorage.setItem('p_id',checked);
                                //删除后将图片换回复选框
                                var html=$('#goods_index').contents();
                                var img=html.find(".ta").find("tbody img[p_id='ck"+p_id+"ck']");
                                var checkbox=html.find(".ta").find("tbody input[p_id='ck"+p_id+"ck']");
                                checkbox.show();
                                checkbox.prop('checked',false);
                                img.remove();
                            });
                        });
                    }
                    $("#myModal2").draggable();
                    $("#myModal3").draggable();
                    $("#tr_add").click(function(){
                        var s=$("#last_tr").prev().find(".goods_order").text();
                        var ss=parseInt(s)+1;
                        var html="";
                        html+="<tr>";
                        html+=$("#tr_info").html();
                        html+="</tr>";
                        $("#last_tr").before(html);
                        $("#last_tr").prev().find(".goods_order").text(ss);
                        table_order();
                        myModal2();
                        del_input();
                    });
                    $('#goods_index').load(function () {
                        $("#check").unbind('click').click(function(){
                            var html=$('#goods_index').contents();
                            var tr=html.find("input[class='goods_input']:checked").parent().parent();
                            var tr2=$(this).parent().parent();
                            tr.each(function(){
                                if ($(this).find("td:nth-child(1)").find("img").length > 0) {
                					
                				}else{
	                                var s=$("#last_tr").prev().find(".goods_order").text();
	                                var ss=parseInt(s)+1;
	                                var p_id=$(this).find(".goods_id_code").find("input").attr("p_id");
	                                var checked=localStorage.getItem('p_id');
	                                checked+=","+p_id;
	                                localStorage.setItem('p_id',checked);
                                    var goods_way=$(this).find(".goods_way").text();
	                                var html="";
	                                html+="<tr id='zz' class='' gold_price='"+$(this).attr('gold_price')+"' gold_type='"+$(this).attr('gold_type')+"'>";
	                                html+='<td class="goods_order text-center" >'+$(this).find(".goods_order").text()+'</td>';
	                                html+=' <td class="goods_code text-center">'+$(this).find(".goods_code").text()+'</td>';
	                                html+=' <td class="goods_name">'+$(this).find(".goods_name").text()+'</td>';
	                               // html+=' <td class="goods_purity text-center">'+$(this).find(".goods_purity").text()+'</td>';
	                                html+=' <td class="goods_spec t">'+$(this).find(".goods_spec").text()+'</td>';
                                    html+=' <td  class="be_onsale_price">'+$(this).find(".goods_unit_price").text()+'</td>';
                                   /* if(goods_way=='计件'){
                                        html+=' <td class="num_stock "><input class ="num_stock" attr="'+$(this).find(".goods_num").text()+
                                                '" type="text" name="num_stock" value='+1+'></td>';
                                    }else {*/
                                    html+=' <td class="num_stock"><input class ="num_stock" num_stock="'+$(this).find(".goods_stock").text()+
                                                '" type="text" name="num_stock" value='+1.000000+'></td>';
                                    html+=' <td class="goods_unit text-center">'+$(this).find(".goods_unit").text()+'</td>';
                                    var sell_fee=$(this).find(".sell_fee").text();
                                    if($.trim(sell_fee)!=='--'){
                                        html+=' <td class="sell_fee"><input class ="sell_fee" type="text" name="sell_fee" value='+$(this).find(".sell_fee").text()+'></td>';
                                        var goods_unit_price=parseFloat($(this).find(".goods_unit_price").text())+parseFloat(sell_fee);
                                    }else {
                                        html+=' <td class="sell_fee">--</td>';
                                        var goods_unit_price=parseFloat($(this).find(".goods_unit_price").text());
                                    }
                                    html+=' <td  class="discount_price"><input type="text" autocomplete="off" name="discount_price" class="discount_price"   value="0"></td>';
                                    html+=' <td  class="goods_unit_price price2"><input type="text" autocomplete="off" name="price2" class="price2" price='+ $(this).find(".goods_unit_price").text()+'  value='+ goods_unit_price+'></td>';
	                                html+='<td class="jijia text-center">'+goods_way+'</td>';
                                    html+='<td class="wgoods_stock_id" hidden ="hidden"><input id ="wgoods_stock_id" type="text" value='+$(this).find(".wgoods_stock_id").text()+'></td>';
                                    html+='<td class="warehouse_id" hidden ="hidden"><input id ="warehouse_id" type="text" value='+$(this).find(".warehouse_id").text()+'></td>';
	                                html+='<td class="goods_id" hidden ="hidden"><input id ="pid" type="text" value='+$(this).find(".goods_id").text()+'></td>';
	                                html+='<td class="text-center">'
	                                html+='<a href="javascript:void(0);" name="{$v.id}"  class="del" role="button" data-toggle="modal">删除</i></a>';
	                                html+='</td>';
	                                html+='</tr>';
	                                $("#last").before(html);
                				}
                            });
                            //刷新页面读取已勾选数据
                            var check=localStorage.getItem('p_id');
                            if(check!=""&&check!=null&&typeof(check)!="undefined"){
                                var checked=check.split(',');
                                for(var i in checked){
                                    if(checked[i]!=null&&checked[i]!=""&&typeof(checked[i])!="undefined"){
                                        var checkbox=tr.find("input[p_id='"+checked[i]+"']");
                                        var imglength=checkbox.parent().find("img").length;
                                        if(checkbox.length>0&&imglength==0){
                                            var img= "<img p_id='"+checked[i]+"' src='__PUBLIC__/images/gou.png'/>";
                                            checkbox.parent().append(img);
                                             checkbox.prop('checked',false);
                                             checkbox.hide();
                                        }
                                    }
                                }
                            }
                            table_order();
                            myModal2();
                            del_input();
                            count_price2();
                            count();	m_frr();discount_price(); num_stock();	del();
                        })
                        $("#add").unbind('click').click(function(){
                            $("#check").trigger("click");
                        })
                    });

                   /* $('#add-2').click(function(){
                        name = localStorage.getItem('sell_name');
                        mobile = localStorage.getItem('sell_mobile');
                        uid = localStorage.getItem('sell_uid');
                        if(empty(name)){
                            name='';
                        }
                        $('#mobile').val(name);
                        $('#uid').val(uid);
                    })*/
                    function myModal2(){
                        $('.myModal2').each(function () {
                            $(this).click(function(){
                                $(".myModal2.on").removeClass("on");
                                $(this).addClass("on");
                                if(!this.hasClass("on")){

								}
                            })

                        })
                    }
                    function save(){
                        $("#baocun").click(function(){
                           /* var saccout_record=getall_pay_type();
                            if(saccout_record==false){
                                return;
                            }*/

                            var names = [];
                            var tr= $(".ta").find('table tbody tr[id="zz"]');
                            var order=new Object();
                            order.create_time=$('#create_time').val();
                            order.remark=$("#remark").val();
                            //order.buyer_id=localStorage.getItem('sell_uid');
                            order.buyer_id=$('#company_name').val();
                            order.count=$('#count').val();
                            tr.each(function(){
                                var wgoods_stock_id=$(this).find(".wgoods_stock_id").find('input').val();
                                if(wgoods_stock_id){
                                    var warehouse_id=$(this).find(".warehouse_id").find('input').val();
                                    var wgoods_stock_id=$(this).find(".wgoods_stock_id").find('input').val();
                                    var id=$(this).find(".goods_id").find('input').val();
                                    var jjfs =$(this).find(".jijia").text();
                                    var num_stock=$(this).find("input[name='num_stock']").val();
                                    var gold_type=$(this).attr('gold_type');
                                    var sell_m_fee =$(this).find(".sell_fee").find('input').val();
                                    var discount_price=$(this).find(".discount_price").find('input').val();
                                    var rell_sell_price =$(this).find(".goods_unit_price").find('input').val();
                                    var be_onsale_price =$(this).find(".be_onsale_price").text();
                                    if(id){
                                        names.push({
                                            'id': id,
                                            'warehouse_id':warehouse_id,
                                            'wgoods_stock_id':wgoods_stock_id,
                                            'be_onsale_price': be_onsale_price,
                                            'discount_price': discount_price,
                                            'sell_price': rell_sell_price,
                                            'sell_m_fee': sell_m_fee,
                                            'sell_pricemode': jjfs,
                                            'num_stock': num_stock,
                                            gold_type: gold_type
                                        });
                                    }
                                }
                            })
                            console.log(names);
                            if(names.length<1){
                                //	alert("请选择需要销售的商品");
                                artdialog_alert('请选择需要销售的商品');
                                $('.tishi').html('请选择需要销售的商品');
                                return false;
                            }
                            names=JSON.stringify(names);
                            var store=order.buyer_id;
                            if(store<1){
                                artdialog_alert('经销商不能为空');
                                $('.tishi').html('经销商不能为空');
                                return false;
                            }

                            tr.each(function(){
                                var id=$(this).find(".wgoods_stock_id").find('input').val();
                                if(id){
                                    if(!$(this).find(".goods_unit_price").find('input').val()){
                                        artdialog_alert('销售价不能为空');
                                        $('.tishi').html('销售价不能为空');
                                        return false;
                                    }
                                    if(!$(this).find(".num_stock").find('input').val()){
                                        artdialog_alert('销售量不能为空');
                                        $('.tishi').html('销售量不能为空');
                                        return false;
                                    }
                                }
                            })
                            var product_count=$("#total_num").text();
                            var shop_id=$("select[name='shop_id']").val();
                            $.ajax({
                                url: "{:U('BWsell/add')}",
                                type: 'post',
                                async: false,
                                data: {store:store,order:order,count:product_count,shop_id:shop_id,order_detail:eval(names)},
                                beforeSend:function(){
                                    $(".baocun").attr("disabled",true);
                                },
                                success: function (data) {
                                    if(data.status==1){
                                        $('.tishi').html('添加成功');
                                        location.href=data.url;
                                    }else if(data.status==0){
                                        $('.tishi').html(data.msg);
                                        $(".baocun").attr("disabled",false);
                                        return false;
                                    }
                                },error: function (data,status) {
                                    $(".baocun").attr("disabled",false);
                                 }
                            })
                        });
					}
                    function count_num(){
                        var num=0;
                        $(".ta").find('table tr').each(function(){
                            if($(this).attr('id')=='zz'){
                                num++;
                            }
                        });
                        $('#total_num').html(num);
                    }
                    save();
</script>

<script>
    //选择收货仓库，自动完善收货管理员信息
    var srcfirst=$("#goods_index").attr("src");
    $("select[name='shop_id']").change(function(){
        localStorage.removeItem('p_id');
        var trleng=$("#tbody").find("tr").length;
        if(trleng>1){
            var html='<tr id="last">';
            html+=$("#last").html();
            html+='</tr>';
            $("#tbody").html(html);
        }
        var src=srcfirst+"&shop_id="+$("select[name='shop_id']").val();
        $("#goods_index").attr("src",src);
        change_countprice();
        change_needprice();
        var default_exchange_rate=$("select[name='shop_id']").find("option:selected").attr("default_rate");
        if(!default_exchange_rate){
            default_exchange_rate=100.00;
        }
        $(".default_rate").text(default_exchange_rate);
        var count_unit=$("select[name='shop_id']").find("option:selected").attr("unit");
        if(!count_unit){
            count_unit="元";
        }
        $(".count_unit").text(count_unit);
    })
    var a = document.getElementById("order_base").offsetWidth;
    $("#order_product").css("width",a);
</script>
